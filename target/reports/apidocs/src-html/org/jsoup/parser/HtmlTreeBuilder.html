<!DOCTYPE HTML>
<html lang>
<head>
<!-- Generated by javadoc (21) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.jsoup.parser, class: HtmlTreeBuilder">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">package org.jsoup.parser;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">import org.jsoup.helper.Validate;</span>
<span class="source-line-no">004</span><span id="line-4">import org.jsoup.internal.Normalizer;</span>
<span class="source-line-no">005</span><span id="line-5">import org.jsoup.internal.StringUtil;</span>
<span class="source-line-no">006</span><span id="line-6">import org.jsoup.nodes.Attributes;</span>
<span class="source-line-no">007</span><span id="line-7">import org.jsoup.nodes.CDataNode;</span>
<span class="source-line-no">008</span><span id="line-8">import org.jsoup.nodes.Comment;</span>
<span class="source-line-no">009</span><span id="line-9">import org.jsoup.nodes.DataNode;</span>
<span class="source-line-no">010</span><span id="line-10">import org.jsoup.nodes.Document;</span>
<span class="source-line-no">011</span><span id="line-11">import org.jsoup.nodes.Element;</span>
<span class="source-line-no">012</span><span id="line-12">import org.jsoup.nodes.FormElement;</span>
<span class="source-line-no">013</span><span id="line-13">import org.jsoup.nodes.Node;</span>
<span class="source-line-no">014</span><span id="line-14">import org.jsoup.nodes.TextNode;</span>
<span class="source-line-no">015</span><span id="line-15">import org.jspecify.annotations.Nullable;</span>
<span class="source-line-no">016</span><span id="line-16"></span>
<span class="source-line-no">017</span><span id="line-17">import java.io.Reader;</span>
<span class="source-line-no">018</span><span id="line-18">import java.io.StringReader;</span>
<span class="source-line-no">019</span><span id="line-19">import java.util.ArrayList;</span>
<span class="source-line-no">020</span><span id="line-20">import java.util.List;</span>
<span class="source-line-no">021</span><span id="line-21"></span>
<span class="source-line-no">022</span><span id="line-22">import static org.jsoup.internal.StringUtil.inSorted;</span>
<span class="source-line-no">023</span><span id="line-23">import static org.jsoup.parser.HtmlTreeBuilderState.Constants.InTableFoster;</span>
<span class="source-line-no">024</span><span id="line-24">import static org.jsoup.parser.HtmlTreeBuilderState.ForeignContent;</span>
<span class="source-line-no">025</span><span id="line-25">import static org.jsoup.parser.Parser.NamespaceHtml;</span>
<span class="source-line-no">026</span><span id="line-26"></span>
<span class="source-line-no">027</span><span id="line-27">/**</span>
<span class="source-line-no">028</span><span id="line-28"> * HTML Tree Builder; creates a DOM from Tokens.</span>
<span class="source-line-no">029</span><span id="line-29"> */</span>
<span class="source-line-no">030</span><span id="line-30">public class HtmlTreeBuilder extends TreeBuilder {</span>
<span class="source-line-no">031</span><span id="line-31">    // tag searches. must be sorted, used in inSorted. HtmlTreeBuilderTest validates they're sorted.</span>
<span class="source-line-no">032</span><span id="line-32">    static final String[] TagsSearchInScope = new String[]{"applet", "caption", "html", "marquee", "object", "table", "td", "th"};</span>
<span class="source-line-no">033</span><span id="line-33">    static final String[] TagSearchList = new String[]{"ol", "ul"};</span>
<span class="source-line-no">034</span><span id="line-34">    static final String[] TagSearchButton = new String[]{"button"};</span>
<span class="source-line-no">035</span><span id="line-35">    static final String[] TagSearchTableScope = new String[]{"html", "table"};</span>
<span class="source-line-no">036</span><span id="line-36">    static final String[] TagSearchSelectScope = new String[]{"optgroup", "option"};</span>
<span class="source-line-no">037</span><span id="line-37">    static final String[] TagSearchEndTags = new String[]{"dd", "dt", "li", "optgroup", "option", "p", "rb", "rp", "rt", "rtc"};</span>
<span class="source-line-no">038</span><span id="line-38">    static final String[] TagThoroughSearchEndTags = new String[]{"caption", "colgroup", "dd", "dt", "li", "optgroup", "option", "p", "rb", "rp", "rt", "rtc", "tbody", "td", "tfoot", "th", "thead", "tr"};</span>
<span class="source-line-no">039</span><span id="line-39">    static final String[] TagSearchSpecial = new String[]{"address", "applet", "area", "article", "aside", "base", "basefont", "bgsound",</span>
<span class="source-line-no">040</span><span id="line-40">        "blockquote", "body", "br", "button", "caption", "center", "col", "colgroup", "command", "dd",</span>
<span class="source-line-no">041</span><span id="line-41">        "details", "dir", "div", "dl", "dt", "embed", "fieldset", "figcaption", "figure", "footer", "form",</span>
<span class="source-line-no">042</span><span id="line-42">        "frame", "frameset", "h1", "h2", "h3", "h4", "h5", "h6", "head", "header", "hgroup", "hr", "html",</span>
<span class="source-line-no">043</span><span id="line-43">        "iframe", "img", "input", "isindex", "li", "link", "listing", "marquee", "menu", "meta", "nav",</span>
<span class="source-line-no">044</span><span id="line-44">        "noembed", "noframes", "noscript", "object", "ol", "p", "param", "plaintext", "pre", "script",</span>
<span class="source-line-no">045</span><span id="line-45">        "section", "select", "style", "summary", "table", "tbody", "td", "textarea", "tfoot", "th", "thead",</span>
<span class="source-line-no">046</span><span id="line-46">        "title", "tr", "ul", "wbr", "xmp"};</span>
<span class="source-line-no">047</span><span id="line-47">    static final String[] TagMathMlTextIntegration = new String[]{"mi", "mn", "mo", "ms", "mtext"};</span>
<span class="source-line-no">048</span><span id="line-48">    static final String[] TagSvgHtmlIntegration = new String[]{"desc", "foreignObject", "title"};</span>
<span class="source-line-no">049</span><span id="line-49"></span>
<span class="source-line-no">050</span><span id="line-50">    public static final int MaxScopeSearchDepth = 100; // prevents the parser bogging down in exceptionally broken pages</span>
<span class="source-line-no">051</span><span id="line-51"></span>
<span class="source-line-no">052</span><span id="line-52">    private HtmlTreeBuilderState state; // the current state</span>
<span class="source-line-no">053</span><span id="line-53">    private HtmlTreeBuilderState originalState; // original / marked state</span>
<span class="source-line-no">054</span><span id="line-54"></span>
<span class="source-line-no">055</span><span id="line-55">    private boolean baseUriSetFromDoc;</span>
<span class="source-line-no">056</span><span id="line-56">    private @Nullable Element headElement; // the current head element</span>
<span class="source-line-no">057</span><span id="line-57">    private @Nullable FormElement formElement; // the current form element</span>
<span class="source-line-no">058</span><span id="line-58">    private @Nullable Element contextElement; // fragment parse root; name only copy of context. could be null even if fragment parsing</span>
<span class="source-line-no">059</span><span id="line-59">    private ArrayList&lt;Element&gt; formattingElements; // active (open) formatting elements</span>
<span class="source-line-no">060</span><span id="line-60">    private ArrayList&lt;HtmlTreeBuilderState&gt; tmplInsertMode; // stack of Template Insertion modes</span>
<span class="source-line-no">061</span><span id="line-61">    private List&lt;Token.Character&gt; pendingTableCharacters; // chars in table to be shifted out</span>
<span class="source-line-no">062</span><span id="line-62">    private Token.EndTag emptyEnd; // reused empty end tag</span>
<span class="source-line-no">063</span><span id="line-63"></span>
<span class="source-line-no">064</span><span id="line-64">    private boolean framesetOk; // if ok to go into frameset</span>
<span class="source-line-no">065</span><span id="line-65">    private boolean fosterInserts; // if next inserts should be fostered</span>
<span class="source-line-no">066</span><span id="line-66">    private boolean fragmentParsing; // if parsing a fragment of html</span>
<span class="source-line-no">067</span><span id="line-67"></span>
<span class="source-line-no">068</span><span id="line-68">    @Override ParseSettings defaultSettings() {</span>
<span class="source-line-no">069</span><span id="line-69">        return ParseSettings.htmlDefault;</span>
<span class="source-line-no">070</span><span id="line-70">    }</span>
<span class="source-line-no">071</span><span id="line-71"></span>
<span class="source-line-no">072</span><span id="line-72">    @Override</span>
<span class="source-line-no">073</span><span id="line-73">    HtmlTreeBuilder newInstance() {</span>
<span class="source-line-no">074</span><span id="line-74">        return new HtmlTreeBuilder();</span>
<span class="source-line-no">075</span><span id="line-75">    }</span>
<span class="source-line-no">076</span><span id="line-76"></span>
<span class="source-line-no">077</span><span id="line-77">    @Override</span>
<span class="source-line-no">078</span><span id="line-78">    protected void initialiseParse(Reader input, String baseUri, Parser parser) {</span>
<span class="source-line-no">079</span><span id="line-79">        super.initialiseParse(input, baseUri, parser);</span>
<span class="source-line-no">080</span><span id="line-80"></span>
<span class="source-line-no">081</span><span id="line-81">        // this is a bit mucky. todo - probably just create new parser objects to ensure all reset.</span>
<span class="source-line-no">082</span><span id="line-82">        state = HtmlTreeBuilderState.Initial;</span>
<span class="source-line-no">083</span><span id="line-83">        originalState = null;</span>
<span class="source-line-no">084</span><span id="line-84">        baseUriSetFromDoc = false;</span>
<span class="source-line-no">085</span><span id="line-85">        headElement = null;</span>
<span class="source-line-no">086</span><span id="line-86">        formElement = null;</span>
<span class="source-line-no">087</span><span id="line-87">        contextElement = null;</span>
<span class="source-line-no">088</span><span id="line-88">        formattingElements = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">089</span><span id="line-89">        tmplInsertMode = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">090</span><span id="line-90">        pendingTableCharacters = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">091</span><span id="line-91">        emptyEnd = new Token.EndTag(this);</span>
<span class="source-line-no">092</span><span id="line-92">        framesetOk = true;</span>
<span class="source-line-no">093</span><span id="line-93">        fosterInserts = false;</span>
<span class="source-line-no">094</span><span id="line-94">        fragmentParsing = false;</span>
<span class="source-line-no">095</span><span id="line-95">    }</span>
<span class="source-line-no">096</span><span id="line-96"></span>
<span class="source-line-no">097</span><span id="line-97">    @Override void initialiseParseFragment(@Nullable Element context) {</span>
<span class="source-line-no">098</span><span id="line-98">        // context may be null</span>
<span class="source-line-no">099</span><span id="line-99">        state = HtmlTreeBuilderState.Initial;</span>
<span class="source-line-no">100</span><span id="line-100">        fragmentParsing = true;</span>
<span class="source-line-no">101</span><span id="line-101"></span>
<span class="source-line-no">102</span><span id="line-102">        if (context != null) {</span>
<span class="source-line-no">103</span><span id="line-103">            final String contextName = context.normalName();</span>
<span class="source-line-no">104</span><span id="line-104">            contextElement = new Element(tagFor(contextName, settings), baseUri);</span>
<span class="source-line-no">105</span><span id="line-105">            if (context.ownerDocument() != null) // quirks setup:</span>
<span class="source-line-no">106</span><span id="line-106">                doc.quirksMode(context.ownerDocument().quirksMode());</span>
<span class="source-line-no">107</span><span id="line-107"></span>
<span class="source-line-no">108</span><span id="line-108">            // initialise the tokeniser state:</span>
<span class="source-line-no">109</span><span id="line-109">            switch (contextName) {</span>
<span class="source-line-no">110</span><span id="line-110">                case "title":</span>
<span class="source-line-no">111</span><span id="line-111">                case "textarea":</span>
<span class="source-line-no">112</span><span id="line-112">                    tokeniser.transition(TokeniserState.Rcdata);</span>
<span class="source-line-no">113</span><span id="line-113">                    break;</span>
<span class="source-line-no">114</span><span id="line-114">                case "iframe":</span>
<span class="source-line-no">115</span><span id="line-115">                case "noembed":</span>
<span class="source-line-no">116</span><span id="line-116">                case "noframes":</span>
<span class="source-line-no">117</span><span id="line-117">                case "style":</span>
<span class="source-line-no">118</span><span id="line-118">                case "xmp":</span>
<span class="source-line-no">119</span><span id="line-119">                    tokeniser.transition(TokeniserState.Rawtext);</span>
<span class="source-line-no">120</span><span id="line-120">                    break;</span>
<span class="source-line-no">121</span><span id="line-121">                case "script":</span>
<span class="source-line-no">122</span><span id="line-122">                    tokeniser.transition(TokeniserState.ScriptData);</span>
<span class="source-line-no">123</span><span id="line-123">                    break;</span>
<span class="source-line-no">124</span><span id="line-124">                case "plaintext":</span>
<span class="source-line-no">125</span><span id="line-125">                    tokeniser.transition(TokeniserState.PLAINTEXT);</span>
<span class="source-line-no">126</span><span id="line-126">                    break;</span>
<span class="source-line-no">127</span><span id="line-127">                case "template":</span>
<span class="source-line-no">128</span><span id="line-128">                    tokeniser.transition(TokeniserState.Data);</span>
<span class="source-line-no">129</span><span id="line-129">                    pushTemplateMode(HtmlTreeBuilderState.InTemplate);</span>
<span class="source-line-no">130</span><span id="line-130">                    break;</span>
<span class="source-line-no">131</span><span id="line-131">                default:</span>
<span class="source-line-no">132</span><span id="line-132">                    tokeniser.transition(TokeniserState.Data);</span>
<span class="source-line-no">133</span><span id="line-133">            }</span>
<span class="source-line-no">134</span><span id="line-134">            doc.appendChild(contextElement);</span>
<span class="source-line-no">135</span><span id="line-135">            push(contextElement);</span>
<span class="source-line-no">136</span><span id="line-136">            resetInsertionMode();</span>
<span class="source-line-no">137</span><span id="line-137"></span>
<span class="source-line-no">138</span><span id="line-138">            // setup form element to nearest form on context (up ancestor chain). ensures form controls are associated</span>
<span class="source-line-no">139</span><span id="line-139">            // with form correctly</span>
<span class="source-line-no">140</span><span id="line-140">            Element formSearch = context;</span>
<span class="source-line-no">141</span><span id="line-141">            while (formSearch != null) {</span>
<span class="source-line-no">142</span><span id="line-142">                if (formSearch instanceof FormElement) {</span>
<span class="source-line-no">143</span><span id="line-143">                    formElement = (FormElement) formSearch;</span>
<span class="source-line-no">144</span><span id="line-144">                    break;</span>
<span class="source-line-no">145</span><span id="line-145">                }</span>
<span class="source-line-no">146</span><span id="line-146">                formSearch = formSearch.parent();</span>
<span class="source-line-no">147</span><span id="line-147">            }</span>
<span class="source-line-no">148</span><span id="line-148">        }</span>
<span class="source-line-no">149</span><span id="line-149">    }</span>
<span class="source-line-no">150</span><span id="line-150"></span>
<span class="source-line-no">151</span><span id="line-151">    @Override List&lt;Node&gt; completeParseFragment() {</span>
<span class="source-line-no">152</span><span id="line-152">        if (contextElement != null) {</span>
<span class="source-line-no">153</span><span id="line-153">            // depending on context and the input html, content may have been added outside of the root el</span>
<span class="source-line-no">154</span><span id="line-154">            // e.g. context=p, input=div, the div will have been pushed out.</span>
<span class="source-line-no">155</span><span id="line-155">            List&lt;Node&gt; nodes = contextElement.siblingNodes();</span>
<span class="source-line-no">156</span><span id="line-156">            if (!nodes.isEmpty())</span>
<span class="source-line-no">157</span><span id="line-157">                contextElement.insertChildren(-1, nodes);</span>
<span class="source-line-no">158</span><span id="line-158">            return contextElement.childNodes();</span>
<span class="source-line-no">159</span><span id="line-159">        }</span>
<span class="source-line-no">160</span><span id="line-160">        else</span>
<span class="source-line-no">161</span><span id="line-161">            return doc.childNodes();</span>
<span class="source-line-no">162</span><span id="line-162">    }</span>
<span class="source-line-no">163</span><span id="line-163"></span>
<span class="source-line-no">164</span><span id="line-164">    @Override</span>
<span class="source-line-no">165</span><span id="line-165">    protected boolean process(Token token) {</span>
<span class="source-line-no">166</span><span id="line-166">        HtmlTreeBuilderState dispatch = useCurrentOrForeignInsert(token) ? this.state : ForeignContent;</span>
<span class="source-line-no">167</span><span id="line-167">        return dispatch.process(token, this);</span>
<span class="source-line-no">168</span><span id="line-168">    }</span>
<span class="source-line-no">169</span><span id="line-169"></span>
<span class="source-line-no">170</span><span id="line-170">    boolean useCurrentOrForeignInsert(Token token) {</span>
<span class="source-line-no">171</span><span id="line-171">        // https://html.spec.whatwg.org/multipage/parsing.html#tree-construction</span>
<span class="source-line-no">172</span><span id="line-172">        // If the stack of open elements is empty</span>
<span class="source-line-no">173</span><span id="line-173">        if (stack.isEmpty())</span>
<span class="source-line-no">174</span><span id="line-174">            return true;</span>
<span class="source-line-no">175</span><span id="line-175">        final Element el = currentElement();</span>
<span class="source-line-no">176</span><span id="line-176">        final String ns = el.tag().namespace();</span>
<span class="source-line-no">177</span><span id="line-177"></span>
<span class="source-line-no">178</span><span id="line-178">        // If the adjusted current node is an element in the HTML namespace</span>
<span class="source-line-no">179</span><span id="line-179">        if (NamespaceHtml.equals(ns))</span>
<span class="source-line-no">180</span><span id="line-180">            return true;</span>
<span class="source-line-no">181</span><span id="line-181"></span>
<span class="source-line-no">182</span><span id="line-182">        // If the adjusted current node is a MathML text integration point and the token is a start tag whose tag name is neither "mglyph" nor "malignmark"</span>
<span class="source-line-no">183</span><span id="line-183">        // If the adjusted current node is a MathML text integration point and the token is a character token</span>
<span class="source-line-no">184</span><span id="line-184">        if (isMathmlTextIntegration(el)) {</span>
<span class="source-line-no">185</span><span id="line-185">            if (token.isStartTag()</span>
<span class="source-line-no">186</span><span id="line-186">                    &amp;&amp; !"mglyph".equals(token.asStartTag().normalName)</span>
<span class="source-line-no">187</span><span id="line-187">                    &amp;&amp; !"malignmark".equals(token.asStartTag().normalName))</span>
<span class="source-line-no">188</span><span id="line-188">                    return true;</span>
<span class="source-line-no">189</span><span id="line-189">            if (token.isCharacter())</span>
<span class="source-line-no">190</span><span id="line-190">                    return true;</span>
<span class="source-line-no">191</span><span id="line-191">        }</span>
<span class="source-line-no">192</span><span id="line-192">        // If the adjusted current node is a MathML annotation-xml element and the token is a start tag whose tag name is "svg"</span>
<span class="source-line-no">193</span><span id="line-193">        if (Parser.NamespaceMathml.equals(ns)</span>
<span class="source-line-no">194</span><span id="line-194">            &amp;&amp; el.nameIs("annotation-xml")</span>
<span class="source-line-no">195</span><span id="line-195">            &amp;&amp; token.isStartTag()</span>
<span class="source-line-no">196</span><span id="line-196">            &amp;&amp; "svg".equals(token.asStartTag().normalName))</span>
<span class="source-line-no">197</span><span id="line-197">            return true;</span>
<span class="source-line-no">198</span><span id="line-198"></span>
<span class="source-line-no">199</span><span id="line-199">        // If the adjusted current node is an HTML integration point and the token is a start tag</span>
<span class="source-line-no">200</span><span id="line-200">        // If the adjusted current node is an HTML integration point and the token is a character token</span>
<span class="source-line-no">201</span><span id="line-201">        if (isHtmlIntegration(el)</span>
<span class="source-line-no">202</span><span id="line-202">            &amp;&amp; (token.isStartTag() || token.isCharacter()))</span>
<span class="source-line-no">203</span><span id="line-203">            return true;</span>
<span class="source-line-no">204</span><span id="line-204"></span>
<span class="source-line-no">205</span><span id="line-205">        // If the token is an end-of-file token</span>
<span class="source-line-no">206</span><span id="line-206">        return token.isEOF();</span>
<span class="source-line-no">207</span><span id="line-207">    }</span>
<span class="source-line-no">208</span><span id="line-208"></span>
<span class="source-line-no">209</span><span id="line-209">    static boolean isMathmlTextIntegration(Element el) {</span>
<span class="source-line-no">210</span><span id="line-210">        /*</span>
<span class="source-line-no">211</span><span id="line-211">        A node is a MathML text integration point if it is one of the following elements:</span>
<span class="source-line-no">212</span><span id="line-212">        A MathML mi element</span>
<span class="source-line-no">213</span><span id="line-213">        A MathML mo element</span>
<span class="source-line-no">214</span><span id="line-214">        A MathML mn element</span>
<span class="source-line-no">215</span><span id="line-215">        A MathML ms element</span>
<span class="source-line-no">216</span><span id="line-216">        A MathML mtext element</span>
<span class="source-line-no">217</span><span id="line-217">         */</span>
<span class="source-line-no">218</span><span id="line-218">        return (Parser.NamespaceMathml.equals(el.tag().namespace())</span>
<span class="source-line-no">219</span><span id="line-219">            &amp;&amp; StringUtil.inSorted(el.normalName(), TagMathMlTextIntegration));</span>
<span class="source-line-no">220</span><span id="line-220">    }</span>
<span class="source-line-no">221</span><span id="line-221"></span>
<span class="source-line-no">222</span><span id="line-222">    static boolean isHtmlIntegration(Element el) {</span>
<span class="source-line-no">223</span><span id="line-223">        /*</span>
<span class="source-line-no">224</span><span id="line-224">        A node is an HTML integration point if it is one of the following elements:</span>
<span class="source-line-no">225</span><span id="line-225">        A MathML annotation-xml element whose start tag token had an attribute with the name "encoding" whose value was an ASCII case-insensitive match for the string "text/html"</span>
<span class="source-line-no">226</span><span id="line-226">        A MathML annotation-xml element whose start tag token had an attribute with the name "encoding" whose value was an ASCII case-insensitive match for the string "application/xhtml+xml"</span>
<span class="source-line-no">227</span><span id="line-227">        An SVG foreignObject element</span>
<span class="source-line-no">228</span><span id="line-228">        An SVG desc element</span>
<span class="source-line-no">229</span><span id="line-229">        An SVG title element</span>
<span class="source-line-no">230</span><span id="line-230">         */</span>
<span class="source-line-no">231</span><span id="line-231">        if (Parser.NamespaceMathml.equals(el.tag().namespace())</span>
<span class="source-line-no">232</span><span id="line-232">            &amp;&amp; el.nameIs("annotation-xml")) {</span>
<span class="source-line-no">233</span><span id="line-233">            String encoding = Normalizer.normalize(el.attr("encoding"));</span>
<span class="source-line-no">234</span><span id="line-234">            if (encoding.equals("text/html") || encoding.equals("application/xhtml+xml"))</span>
<span class="source-line-no">235</span><span id="line-235">                return true;</span>
<span class="source-line-no">236</span><span id="line-236">        }</span>
<span class="source-line-no">237</span><span id="line-237">        if (Parser.NamespaceSvg.equals(el.tag().namespace())</span>
<span class="source-line-no">238</span><span id="line-238">            &amp;&amp; StringUtil.in(el.tagName(), TagSvgHtmlIntegration)) // note using .tagName for case-sensitive hit here of foreignObject</span>
<span class="source-line-no">239</span><span id="line-239">            return true;</span>
<span class="source-line-no">240</span><span id="line-240"></span>
<span class="source-line-no">241</span><span id="line-241">        return false;</span>
<span class="source-line-no">242</span><span id="line-242">    }</span>
<span class="source-line-no">243</span><span id="line-243"></span>
<span class="source-line-no">244</span><span id="line-244">    boolean process(Token token, HtmlTreeBuilderState state) {</span>
<span class="source-line-no">245</span><span id="line-245">        return state.process(token, this);</span>
<span class="source-line-no">246</span><span id="line-246">    }</span>
<span class="source-line-no">247</span><span id="line-247"></span>
<span class="source-line-no">248</span><span id="line-248">    void transition(HtmlTreeBuilderState state) {</span>
<span class="source-line-no">249</span><span id="line-249">        this.state = state;</span>
<span class="source-line-no">250</span><span id="line-250">    }</span>
<span class="source-line-no">251</span><span id="line-251"></span>
<span class="source-line-no">252</span><span id="line-252">    HtmlTreeBuilderState state() {</span>
<span class="source-line-no">253</span><span id="line-253">        return state;</span>
<span class="source-line-no">254</span><span id="line-254">    }</span>
<span class="source-line-no">255</span><span id="line-255"></span>
<span class="source-line-no">256</span><span id="line-256">    void markInsertionMode() {</span>
<span class="source-line-no">257</span><span id="line-257">        originalState = state;</span>
<span class="source-line-no">258</span><span id="line-258">    }</span>
<span class="source-line-no">259</span><span id="line-259"></span>
<span class="source-line-no">260</span><span id="line-260">    HtmlTreeBuilderState originalState() {</span>
<span class="source-line-no">261</span><span id="line-261">        return originalState;</span>
<span class="source-line-no">262</span><span id="line-262">    }</span>
<span class="source-line-no">263</span><span id="line-263"></span>
<span class="source-line-no">264</span><span id="line-264">    void framesetOk(boolean framesetOk) {</span>
<span class="source-line-no">265</span><span id="line-265">        this.framesetOk = framesetOk;</span>
<span class="source-line-no">266</span><span id="line-266">    }</span>
<span class="source-line-no">267</span><span id="line-267"></span>
<span class="source-line-no">268</span><span id="line-268">    boolean framesetOk() {</span>
<span class="source-line-no">269</span><span id="line-269">        return framesetOk;</span>
<span class="source-line-no">270</span><span id="line-270">    }</span>
<span class="source-line-no">271</span><span id="line-271"></span>
<span class="source-line-no">272</span><span id="line-272">    Document getDocument() {</span>
<span class="source-line-no">273</span><span id="line-273">        return doc;</span>
<span class="source-line-no">274</span><span id="line-274">    }</span>
<span class="source-line-no">275</span><span id="line-275"></span>
<span class="source-line-no">276</span><span id="line-276">    String getBaseUri() {</span>
<span class="source-line-no">277</span><span id="line-277">        return baseUri;</span>
<span class="source-line-no">278</span><span id="line-278">    }</span>
<span class="source-line-no">279</span><span id="line-279"></span>
<span class="source-line-no">280</span><span id="line-280">    void maybeSetBaseUri(Element base) {</span>
<span class="source-line-no">281</span><span id="line-281">        if (baseUriSetFromDoc) // only listen to the first &lt;base href&gt; in parse</span>
<span class="source-line-no">282</span><span id="line-282">            return;</span>
<span class="source-line-no">283</span><span id="line-283"></span>
<span class="source-line-no">284</span><span id="line-284">        String href = base.absUrl("href");</span>
<span class="source-line-no">285</span><span id="line-285">        if (href.length() != 0) { // ignore &lt;base target&gt; etc</span>
<span class="source-line-no">286</span><span id="line-286">            baseUri = href;</span>
<span class="source-line-no">287</span><span id="line-287">            baseUriSetFromDoc = true;</span>
<span class="source-line-no">288</span><span id="line-288">            doc.setBaseUri(href); // set on the doc so doc.createElement(Tag) will get updated base, and to update all descendants</span>
<span class="source-line-no">289</span><span id="line-289">        }</span>
<span class="source-line-no">290</span><span id="line-290">    }</span>
<span class="source-line-no">291</span><span id="line-291"></span>
<span class="source-line-no">292</span><span id="line-292">    boolean isFragmentParsing() {</span>
<span class="source-line-no">293</span><span id="line-293">        return fragmentParsing;</span>
<span class="source-line-no">294</span><span id="line-294">    }</span>
<span class="source-line-no">295</span><span id="line-295"></span>
<span class="source-line-no">296</span><span id="line-296">    void error(HtmlTreeBuilderState state) {</span>
<span class="source-line-no">297</span><span id="line-297">        if (parser.getErrors().canAddError())</span>
<span class="source-line-no">298</span><span id="line-298">            parser.getErrors().add(new ParseError(reader, "Unexpected %s token [%s] when in state [%s]",</span>
<span class="source-line-no">299</span><span id="line-299">                currentToken.tokenType(), currentToken, state));</span>
<span class="source-line-no">300</span><span id="line-300">    }</span>
<span class="source-line-no">301</span><span id="line-301"></span>
<span class="source-line-no">302</span><span id="line-302">    Element createElementFor(Token.StartTag startTag, String namespace, boolean forcePreserveCase) {</span>
<span class="source-line-no">303</span><span id="line-303">        // dedupe and normalize the attributes:</span>
<span class="source-line-no">304</span><span id="line-304">        Attributes attributes = startTag.attributes;</span>
<span class="source-line-no">305</span><span id="line-305">        if (!forcePreserveCase)</span>
<span class="source-line-no">306</span><span id="line-306">            attributes = settings.normalizeAttributes(attributes);</span>
<span class="source-line-no">307</span><span id="line-307">        if (attributes != null &amp;&amp; !attributes.isEmpty()) {</span>
<span class="source-line-no">308</span><span id="line-308">            int dupes = attributes.deduplicate(settings);</span>
<span class="source-line-no">309</span><span id="line-309">            if (dupes &gt; 0) {</span>
<span class="source-line-no">310</span><span id="line-310">                error("Dropped duplicate attribute(s) in tag [%s]", startTag.normalName);</span>
<span class="source-line-no">311</span><span id="line-311">            }</span>
<span class="source-line-no">312</span><span id="line-312">        }</span>
<span class="source-line-no">313</span><span id="line-313"></span>
<span class="source-line-no">314</span><span id="line-314">        Tag tag = tagFor(startTag.tagName, namespace,</span>
<span class="source-line-no">315</span><span id="line-315">            forcePreserveCase ? ParseSettings.preserveCase : settings);</span>
<span class="source-line-no">316</span><span id="line-316"></span>
<span class="source-line-no">317</span><span id="line-317">        return (tag.normalName().equals("form")) ?</span>
<span class="source-line-no">318</span><span id="line-318">            new FormElement(tag, null, attributes) :</span>
<span class="source-line-no">319</span><span id="line-319">            new Element(tag, null, attributes);</span>
<span class="source-line-no">320</span><span id="line-320">    }</span>
<span class="source-line-no">321</span><span id="line-321"></span>
<span class="source-line-no">322</span><span id="line-322">    /** Inserts an HTML element for the given tag) */</span>
<span class="source-line-no">323</span><span id="line-323">    Element insertElementFor(final Token.StartTag startTag) {</span>
<span class="source-line-no">324</span><span id="line-324">        Element el = createElementFor(startTag, NamespaceHtml, false);</span>
<span class="source-line-no">325</span><span id="line-325">        doInsertElement(el, startTag);</span>
<span class="source-line-no">326</span><span id="line-326"></span>
<span class="source-line-no">327</span><span id="line-327">        // handle self-closing tags. when the spec expects an empty tag, will directly hit insertEmpty, so won't generate this fake end tag.</span>
<span class="source-line-no">328</span><span id="line-328">        if (startTag.isSelfClosing()) {</span>
<span class="source-line-no">329</span><span id="line-329">            Tag tag = el.tag();</span>
<span class="source-line-no">330</span><span id="line-330">            if (tag.isKnownTag()) {</span>
<span class="source-line-no">331</span><span id="line-331">                if (!tag.isEmpty())</span>
<span class="source-line-no">332</span><span id="line-332">                    tokeniser.error("Tag [%s] cannot be self closing; not a void tag", tag.normalName());</span>
<span class="source-line-no">333</span><span id="line-333">                // else: ok</span>
<span class="source-line-no">334</span><span id="line-334">            }</span>
<span class="source-line-no">335</span><span id="line-335">            else { // unknown tag: remember this is self-closing, for output</span>
<span class="source-line-no">336</span><span id="line-336">                tag.setSelfClosing();</span>
<span class="source-line-no">337</span><span id="line-337">            }</span>
<span class="source-line-no">338</span><span id="line-338"></span>
<span class="source-line-no">339</span><span id="line-339">            // effectively a pop, but fiddles with the state. handles empty style, title etc which would otherwise leave us in data state</span>
<span class="source-line-no">340</span><span id="line-340">            tokeniser.transition(TokeniserState.Data); // handles &lt;script /&gt;, otherwise needs breakout steps from script data</span>
<span class="source-line-no">341</span><span id="line-341">            tokeniser.emit(emptyEnd.reset().name(el.tagName()));  // ensure we get out of whatever state we are in. emitted for yielded processing</span>
<span class="source-line-no">342</span><span id="line-342">        }</span>
<span class="source-line-no">343</span><span id="line-343"></span>
<span class="source-line-no">344</span><span id="line-344">        return el;</span>
<span class="source-line-no">345</span><span id="line-345">    }</span>
<span class="source-line-no">346</span><span id="line-346"></span>
<span class="source-line-no">347</span><span id="line-347">    /**</span>
<span class="source-line-no">348</span><span id="line-348">     Inserts a foreign element. Preserves the case of the tag name and of the attributes.</span>
<span class="source-line-no">349</span><span id="line-349">     */</span>
<span class="source-line-no">350</span><span id="line-350">    Element insertForeignElementFor(final Token.StartTag startTag, String namespace) {</span>
<span class="source-line-no">351</span><span id="line-351">        Element el = createElementFor(startTag, namespace, true);</span>
<span class="source-line-no">352</span><span id="line-352">        doInsertElement(el, startTag);</span>
<span class="source-line-no">353</span><span id="line-353"></span>
<span class="source-line-no">354</span><span id="line-354">        if (startTag.isSelfClosing()) {</span>
<span class="source-line-no">355</span><span id="line-355">            el.tag().setSelfClosing(); // remember this is self-closing for output</span>
<span class="source-line-no">356</span><span id="line-356">            pop();</span>
<span class="source-line-no">357</span><span id="line-357">        }</span>
<span class="source-line-no">358</span><span id="line-358"></span>
<span class="source-line-no">359</span><span id="line-359">        return el;</span>
<span class="source-line-no">360</span><span id="line-360">    }</span>
<span class="source-line-no">361</span><span id="line-361"></span>
<span class="source-line-no">362</span><span id="line-362">    Element insertEmptyElementFor(Token.StartTag startTag) {</span>
<span class="source-line-no">363</span><span id="line-363">        Element el = createElementFor(startTag, NamespaceHtml, false);</span>
<span class="source-line-no">364</span><span id="line-364">        doInsertElement(el, startTag);</span>
<span class="source-line-no">365</span><span id="line-365">        pop();</span>
<span class="source-line-no">366</span><span id="line-366">        return el;</span>
<span class="source-line-no">367</span><span id="line-367">    }</span>
<span class="source-line-no">368</span><span id="line-368"></span>
<span class="source-line-no">369</span><span id="line-369">    FormElement insertFormElement(Token.StartTag startTag, boolean onStack, boolean checkTemplateStack) {</span>
<span class="source-line-no">370</span><span id="line-370">        FormElement el = (FormElement) createElementFor(startTag, NamespaceHtml, false);</span>
<span class="source-line-no">371</span><span id="line-371"></span>
<span class="source-line-no">372</span><span id="line-372">        if (checkTemplateStack) {</span>
<span class="source-line-no">373</span><span id="line-373">            if(!onStack("template"))</span>
<span class="source-line-no">374</span><span id="line-374">                setFormElement(el);</span>
<span class="source-line-no">375</span><span id="line-375">        } else</span>
<span class="source-line-no">376</span><span id="line-376">            setFormElement(el);</span>
<span class="source-line-no">377</span><span id="line-377"></span>
<span class="source-line-no">378</span><span id="line-378">        doInsertElement(el, startTag);</span>
<span class="source-line-no">379</span><span id="line-379">        if (!onStack) pop();</span>
<span class="source-line-no">380</span><span id="line-380">        return el;</span>
<span class="source-line-no">381</span><span id="line-381">    }</span>
<span class="source-line-no">382</span><span id="line-382"></span>
<span class="source-line-no">383</span><span id="line-383">    /** Inserts the Element onto the stack. All element inserts must run through this method. Performs any general</span>
<span class="source-line-no">384</span><span id="line-384">     tests on the Element before insertion.</span>
<span class="source-line-no">385</span><span id="line-385">     * @param el the Element to insert and make the current element</span>
<span class="source-line-no">386</span><span id="line-386">     * @param token the token this element was parsed from. If null, uses a zero-width current token as intrinsic insert</span>
<span class="source-line-no">387</span><span id="line-387">     */</span>
<span class="source-line-no">388</span><span id="line-388">    private void doInsertElement(Element el, @Nullable Token token) {</span>
<span class="source-line-no">389</span><span id="line-389">        if (el.tag().isFormListed() &amp;&amp; formElement != null)</span>
<span class="source-line-no">390</span><span id="line-390">            formElement.addElement(el); // connect form controls to their form element</span>
<span class="source-line-no">391</span><span id="line-391"></span>
<span class="source-line-no">392</span><span id="line-392">        // in HTML, the xmlns attribute if set must match what the parser set the tag's namespace to</span>
<span class="source-line-no">393</span><span id="line-393">        if (parser.getErrors().canAddError() &amp;&amp; el.hasAttr("xmlns") &amp;&amp; !el.attr("xmlns").equals(el.tag().namespace()))</span>
<span class="source-line-no">394</span><span id="line-394">            error("Invalid xmlns attribute [%s] on tag [%s]", el.attr("xmlns"), el.tagName());</span>
<span class="source-line-no">395</span><span id="line-395"></span>
<span class="source-line-no">396</span><span id="line-396">        if (isFosterInserts() &amp;&amp; StringUtil.inSorted(currentElement().normalName(), InTableFoster))</span>
<span class="source-line-no">397</span><span id="line-397">            insertInFosterParent(el);</span>
<span class="source-line-no">398</span><span id="line-398">        else</span>
<span class="source-line-no">399</span><span id="line-399">            currentElement().appendChild(el);</span>
<span class="source-line-no">400</span><span id="line-400"></span>
<span class="source-line-no">401</span><span id="line-401">        push(el);</span>
<span class="source-line-no">402</span><span id="line-402">    }</span>
<span class="source-line-no">403</span><span id="line-403"></span>
<span class="source-line-no">404</span><span id="line-404">    void insertCommentNode(Token.Comment token) {</span>
<span class="source-line-no">405</span><span id="line-405">        Comment node = new Comment(token.getData());</span>
<span class="source-line-no">406</span><span id="line-406">        currentElement().appendChild(node);</span>
<span class="source-line-no">407</span><span id="line-407">        onNodeInserted(node);</span>
<span class="source-line-no">408</span><span id="line-408">    }</span>
<span class="source-line-no">409</span><span id="line-409"></span>
<span class="source-line-no">410</span><span id="line-410">    /** Inserts the provided character token into the current element. */</span>
<span class="source-line-no">411</span><span id="line-411">    void insertCharacterNode(Token.Character characterToken) {</span>
<span class="source-line-no">412</span><span id="line-412">        Element el = currentElement(); // will be doc if no current element; allows for whitespace to be inserted into the doc root object (not on the stack)</span>
<span class="source-line-no">413</span><span id="line-413">        insertCharacterToElement(characterToken, el);</span>
<span class="source-line-no">414</span><span id="line-414">    }</span>
<span class="source-line-no">415</span><span id="line-415"></span>
<span class="source-line-no">416</span><span id="line-416">    /** Inserts the provided character token into the provided element. */</span>
<span class="source-line-no">417</span><span id="line-417">    void insertCharacterToElement(Token.Character characterToken, Element el) {</span>
<span class="source-line-no">418</span><span id="line-418">        final Node node;</span>
<span class="source-line-no">419</span><span id="line-419">        final String tagName = el.normalName();</span>
<span class="source-line-no">420</span><span id="line-420">        final String data = characterToken.getData();</span>
<span class="source-line-no">421</span><span id="line-421"></span>
<span class="source-line-no">422</span><span id="line-422">        if (characterToken.isCData())</span>
<span class="source-line-no">423</span><span id="line-423">            node = new CDataNode(data);</span>
<span class="source-line-no">424</span><span id="line-424">        else if (isContentForTagData(tagName))</span>
<span class="source-line-no">425</span><span id="line-425">            node = new DataNode(data);</span>
<span class="source-line-no">426</span><span id="line-426">        else</span>
<span class="source-line-no">427</span><span id="line-427">            node = new TextNode(data);</span>
<span class="source-line-no">428</span><span id="line-428">        el.appendChild(node); // doesn't use insertNode, because we don't foster these; and will always have a stack.</span>
<span class="source-line-no">429</span><span id="line-429">        onNodeInserted(node);</span>
<span class="source-line-no">430</span><span id="line-430">    }</span>
<span class="source-line-no">431</span><span id="line-431"></span>
<span class="source-line-no">432</span><span id="line-432">    ArrayList&lt;Element&gt; getStack() {</span>
<span class="source-line-no">433</span><span id="line-433">        return stack;</span>
<span class="source-line-no">434</span><span id="line-434">    }</span>
<span class="source-line-no">435</span><span id="line-435"></span>
<span class="source-line-no">436</span><span id="line-436">    boolean onStack(Element el) {</span>
<span class="source-line-no">437</span><span id="line-437">        return onStack(stack, el);</span>
<span class="source-line-no">438</span><span id="line-438">    }</span>
<span class="source-line-no">439</span><span id="line-439"></span>
<span class="source-line-no">440</span><span id="line-440">    /** Checks if there is an HTML element with the given name on the stack. */</span>
<span class="source-line-no">441</span><span id="line-441">    boolean onStack(String elName) {</span>
<span class="source-line-no">442</span><span id="line-442">        return getFromStack(elName) != null;</span>
<span class="source-line-no">443</span><span id="line-443">    }</span>
<span class="source-line-no">444</span><span id="line-444"></span>
<span class="source-line-no">445</span><span id="line-445">    private static final int maxQueueDepth = 256; // an arbitrary tension point between real HTML and crafted pain</span>
<span class="source-line-no">446</span><span id="line-446">    private static boolean onStack(ArrayList&lt;Element&gt; queue, Element element) {</span>
<span class="source-line-no">447</span><span id="line-447">        final int bottom = queue.size() - 1;</span>
<span class="source-line-no">448</span><span id="line-448">        final int upper = bottom &gt;= maxQueueDepth ? bottom - maxQueueDepth : 0;</span>
<span class="source-line-no">449</span><span id="line-449">        for (int pos = bottom; pos &gt;= upper; pos--) {</span>
<span class="source-line-no">450</span><span id="line-450">            Element next = queue.get(pos);</span>
<span class="source-line-no">451</span><span id="line-451">            if (next == element) {</span>
<span class="source-line-no">452</span><span id="line-452">                return true;</span>
<span class="source-line-no">453</span><span id="line-453">            }</span>
<span class="source-line-no">454</span><span id="line-454">        }</span>
<span class="source-line-no">455</span><span id="line-455">        return false;</span>
<span class="source-line-no">456</span><span id="line-456">    }</span>
<span class="source-line-no">457</span><span id="line-457"></span>
<span class="source-line-no">458</span><span id="line-458">    /** Gets the nearest (lowest) HTML element with the given name from the stack. */</span>
<span class="source-line-no">459</span><span id="line-459">    @Nullable</span>
<span class="source-line-no">460</span><span id="line-460">    Element getFromStack(String elName) {</span>
<span class="source-line-no">461</span><span id="line-461">        final int bottom = stack.size() - 1;</span>
<span class="source-line-no">462</span><span id="line-462">        final int upper = bottom &gt;= maxQueueDepth ? bottom - maxQueueDepth : 0;</span>
<span class="source-line-no">463</span><span id="line-463">        for (int pos = bottom; pos &gt;= upper; pos--) {</span>
<span class="source-line-no">464</span><span id="line-464">            Element next = stack.get(pos);</span>
<span class="source-line-no">465</span><span id="line-465">            if (next.elementIs(elName, NamespaceHtml)) {</span>
<span class="source-line-no">466</span><span id="line-466">                return next;</span>
<span class="source-line-no">467</span><span id="line-467">            }</span>
<span class="source-line-no">468</span><span id="line-468">        }</span>
<span class="source-line-no">469</span><span id="line-469">        return null;</span>
<span class="source-line-no">470</span><span id="line-470">    }</span>
<span class="source-line-no">471</span><span id="line-471"></span>
<span class="source-line-no">472</span><span id="line-472">    boolean removeFromStack(Element el) {</span>
<span class="source-line-no">473</span><span id="line-473">        for (int pos = stack.size() -1; pos &gt;= 0; pos--) {</span>
<span class="source-line-no">474</span><span id="line-474">            Element next = stack.get(pos);</span>
<span class="source-line-no">475</span><span id="line-475">            if (next == el) {</span>
<span class="source-line-no">476</span><span id="line-476">                stack.remove(pos);</span>
<span class="source-line-no">477</span><span id="line-477">                onNodeClosed(el);</span>
<span class="source-line-no">478</span><span id="line-478">                return true;</span>
<span class="source-line-no">479</span><span id="line-479">            }</span>
<span class="source-line-no">480</span><span id="line-480">        }</span>
<span class="source-line-no">481</span><span id="line-481">        return false;</span>
<span class="source-line-no">482</span><span id="line-482">    }</span>
<span class="source-line-no">483</span><span id="line-483"></span>
<span class="source-line-no">484</span><span id="line-484">    /** Pops the stack until the given HTML element is removed. */</span>
<span class="source-line-no">485</span><span id="line-485">    @Nullable</span>
<span class="source-line-no">486</span><span id="line-486">    Element popStackToClose(String elName) {</span>
<span class="source-line-no">487</span><span id="line-487">        for (int pos = stack.size() -1; pos &gt;= 0; pos--) {</span>
<span class="source-line-no">488</span><span id="line-488">            Element el = pop();</span>
<span class="source-line-no">489</span><span id="line-489">            if (el.elementIs(elName, NamespaceHtml)) {</span>
<span class="source-line-no">490</span><span id="line-490">                return el;</span>
<span class="source-line-no">491</span><span id="line-491">            }</span>
<span class="source-line-no">492</span><span id="line-492">        }</span>
<span class="source-line-no">493</span><span id="line-493">        return null;</span>
<span class="source-line-no">494</span><span id="line-494">    }</span>
<span class="source-line-no">495</span><span id="line-495"></span>
<span class="source-line-no">496</span><span id="line-496">    /** Pops the stack until an element with the supplied name is removed, irrespective of namespace. */</span>
<span class="source-line-no">497</span><span id="line-497">    @Nullable</span>
<span class="source-line-no">498</span><span id="line-498">    Element popStackToCloseAnyNamespace(String elName) {</span>
<span class="source-line-no">499</span><span id="line-499">        for (int pos = stack.size() -1; pos &gt;= 0; pos--) {</span>
<span class="source-line-no">500</span><span id="line-500">            Element el = pop();</span>
<span class="source-line-no">501</span><span id="line-501">            if (el.nameIs(elName)) {</span>
<span class="source-line-no">502</span><span id="line-502">                return el;</span>
<span class="source-line-no">503</span><span id="line-503">            }</span>
<span class="source-line-no">504</span><span id="line-504">        }</span>
<span class="source-line-no">505</span><span id="line-505">        return null;</span>
<span class="source-line-no">506</span><span id="line-506">    }</span>
<span class="source-line-no">507</span><span id="line-507"></span>
<span class="source-line-no">508</span><span id="line-508">    /** Pops the stack until one of the given HTML elements is removed. */</span>
<span class="source-line-no">509</span><span id="line-509">    void popStackToClose(String... elNames) { // elnames is sorted, comes from Constants</span>
<span class="source-line-no">510</span><span id="line-510">        for (int pos = stack.size() -1; pos &gt;= 0; pos--) {</span>
<span class="source-line-no">511</span><span id="line-511">            Element el = pop();</span>
<span class="source-line-no">512</span><span id="line-512">            if (inSorted(el.normalName(), elNames) &amp;&amp; NamespaceHtml.equals(el.tag().namespace())) {</span>
<span class="source-line-no">513</span><span id="line-513">                break;</span>
<span class="source-line-no">514</span><span id="line-514">            }</span>
<span class="source-line-no">515</span><span id="line-515">        }</span>
<span class="source-line-no">516</span><span id="line-516">    }</span>
<span class="source-line-no">517</span><span id="line-517"></span>
<span class="source-line-no">518</span><span id="line-518">    void clearStackToTableContext() {</span>
<span class="source-line-no">519</span><span id="line-519">        clearStackToContext("table", "template");</span>
<span class="source-line-no">520</span><span id="line-520">    }</span>
<span class="source-line-no">521</span><span id="line-521"></span>
<span class="source-line-no">522</span><span id="line-522">    void clearStackToTableBodyContext() {</span>
<span class="source-line-no">523</span><span id="line-523">        clearStackToContext("tbody", "tfoot", "thead", "template");</span>
<span class="source-line-no">524</span><span id="line-524">    }</span>
<span class="source-line-no">525</span><span id="line-525"></span>
<span class="source-line-no">526</span><span id="line-526">    void clearStackToTableRowContext() {</span>
<span class="source-line-no">527</span><span id="line-527">        clearStackToContext("tr", "template");</span>
<span class="source-line-no">528</span><span id="line-528">    }</span>
<span class="source-line-no">529</span><span id="line-529"></span>
<span class="source-line-no">530</span><span id="line-530">    /** Removes elements from the stack until one of the supplied HTML elements is removed. */</span>
<span class="source-line-no">531</span><span id="line-531">    private void clearStackToContext(String... nodeNames) {</span>
<span class="source-line-no">532</span><span id="line-532">        for (int pos = stack.size() -1; pos &gt;= 0; pos--) {</span>
<span class="source-line-no">533</span><span id="line-533">            Element next = stack.get(pos);</span>
<span class="source-line-no">534</span><span id="line-534">            if (NamespaceHtml.equals(next.tag().namespace()) &amp;&amp;</span>
<span class="source-line-no">535</span><span id="line-535">                (StringUtil.in(next.normalName(), nodeNames) || next.nameIs("html")))</span>
<span class="source-line-no">536</span><span id="line-536">                break;</span>
<span class="source-line-no">537</span><span id="line-537">            else</span>
<span class="source-line-no">538</span><span id="line-538">                pop();</span>
<span class="source-line-no">539</span><span id="line-539">        }</span>
<span class="source-line-no">540</span><span id="line-540">    }</span>
<span class="source-line-no">541</span><span id="line-541"></span>
<span class="source-line-no">542</span><span id="line-542">    @Nullable Element aboveOnStack(Element el) {</span>
<span class="source-line-no">543</span><span id="line-543">        assert onStack(el);</span>
<span class="source-line-no">544</span><span id="line-544">        for (int pos = stack.size() -1; pos &gt;= 0; pos--) {</span>
<span class="source-line-no">545</span><span id="line-545">            Element next = stack.get(pos);</span>
<span class="source-line-no">546</span><span id="line-546">            if (next == el) {</span>
<span class="source-line-no">547</span><span id="line-547">                return stack.get(pos-1);</span>
<span class="source-line-no">548</span><span id="line-548">            }</span>
<span class="source-line-no">549</span><span id="line-549">        }</span>
<span class="source-line-no">550</span><span id="line-550">        return null;</span>
<span class="source-line-no">551</span><span id="line-551">    }</span>
<span class="source-line-no">552</span><span id="line-552"></span>
<span class="source-line-no">553</span><span id="line-553">    void insertOnStackAfter(Element after, Element in) {</span>
<span class="source-line-no">554</span><span id="line-554">        int i = stack.lastIndexOf(after);</span>
<span class="source-line-no">555</span><span id="line-555">        Validate.isTrue(i != -1);</span>
<span class="source-line-no">556</span><span id="line-556">        stack.add(i+1, in);</span>
<span class="source-line-no">557</span><span id="line-557">    }</span>
<span class="source-line-no">558</span><span id="line-558"></span>
<span class="source-line-no">559</span><span id="line-559">    void replaceOnStack(Element out, Element in) {</span>
<span class="source-line-no">560</span><span id="line-560">        replaceInQueue(stack, out, in);</span>
<span class="source-line-no">561</span><span id="line-561">    }</span>
<span class="source-line-no">562</span><span id="line-562"></span>
<span class="source-line-no">563</span><span id="line-563">    private static void replaceInQueue(ArrayList&lt;Element&gt; queue, Element out, Element in) {</span>
<span class="source-line-no">564</span><span id="line-564">        int i = queue.lastIndexOf(out);</span>
<span class="source-line-no">565</span><span id="line-565">        Validate.isTrue(i != -1);</span>
<span class="source-line-no">566</span><span id="line-566">        queue.set(i, in);</span>
<span class="source-line-no">567</span><span id="line-567">    }</span>
<span class="source-line-no">568</span><span id="line-568"></span>
<span class="source-line-no">569</span><span id="line-569">    /**</span>
<span class="source-line-no">570</span><span id="line-570">     * Reset the insertion mode, by searching up the stack for an appropriate insertion mode. The stack search depth</span>
<span class="source-line-no">571</span><span id="line-571">     * is limited to {@link #maxQueueDepth}.</span>
<span class="source-line-no">572</span><span id="line-572">     * @return true if the insertion mode was actually changed.</span>
<span class="source-line-no">573</span><span id="line-573">     */</span>
<span class="source-line-no">574</span><span id="line-574">    boolean resetInsertionMode() {</span>
<span class="source-line-no">575</span><span id="line-575">        // https://html.spec.whatwg.org/multipage/parsing.html#the-insertion-mode</span>
<span class="source-line-no">576</span><span id="line-576">        boolean last = false;</span>
<span class="source-line-no">577</span><span id="line-577">        final int bottom = stack.size() - 1;</span>
<span class="source-line-no">578</span><span id="line-578">        final int upper = bottom &gt;= maxQueueDepth ? bottom - maxQueueDepth : 0;</span>
<span class="source-line-no">579</span><span id="line-579">        final HtmlTreeBuilderState origState = this.state;</span>
<span class="source-line-no">580</span><span id="line-580"></span>
<span class="source-line-no">581</span><span id="line-581">        if (stack.size() == 0) { // nothing left of stack, just get to body</span>
<span class="source-line-no">582</span><span id="line-582">            transition(HtmlTreeBuilderState.InBody);</span>
<span class="source-line-no">583</span><span id="line-583">        }</span>
<span class="source-line-no">584</span><span id="line-584"></span>
<span class="source-line-no">585</span><span id="line-585">        LOOP: for (int pos = bottom; pos &gt;= upper; pos--) {</span>
<span class="source-line-no">586</span><span id="line-586">            Element node = stack.get(pos);</span>
<span class="source-line-no">587</span><span id="line-587">            if (pos == upper) {</span>
<span class="source-line-no">588</span><span id="line-588">                last = true;</span>
<span class="source-line-no">589</span><span id="line-589">                if (fragmentParsing)</span>
<span class="source-line-no">590</span><span id="line-590">                    node = contextElement;</span>
<span class="source-line-no">591</span><span id="line-591">            }</span>
<span class="source-line-no">592</span><span id="line-592">            String name = node != null ? node.normalName() : "";</span>
<span class="source-line-no">593</span><span id="line-593">            if (!NamespaceHtml.equals(node.tag().namespace()))</span>
<span class="source-line-no">594</span><span id="line-594">                continue; // only looking for HTML elements here</span>
<span class="source-line-no">595</span><span id="line-595"></span>
<span class="source-line-no">596</span><span id="line-596">            switch (name) {</span>
<span class="source-line-no">597</span><span id="line-597">                case "select":</span>
<span class="source-line-no">598</span><span id="line-598">                    transition(HtmlTreeBuilderState.InSelect);</span>
<span class="source-line-no">599</span><span id="line-599">                    // todo - should loop up (with some limit) and check for table or template hits</span>
<span class="source-line-no">600</span><span id="line-600">                    break LOOP;</span>
<span class="source-line-no">601</span><span id="line-601">                case "td":</span>
<span class="source-line-no">602</span><span id="line-602">                case "th":</span>
<span class="source-line-no">603</span><span id="line-603">                    if (!last) {</span>
<span class="source-line-no">604</span><span id="line-604">                        transition(HtmlTreeBuilderState.InCell);</span>
<span class="source-line-no">605</span><span id="line-605">                        break LOOP;</span>
<span class="source-line-no">606</span><span id="line-606">                    }</span>
<span class="source-line-no">607</span><span id="line-607">                    break;</span>
<span class="source-line-no">608</span><span id="line-608">                case "tr":</span>
<span class="source-line-no">609</span><span id="line-609">                    transition(HtmlTreeBuilderState.InRow);</span>
<span class="source-line-no">610</span><span id="line-610">                    break LOOP;</span>
<span class="source-line-no">611</span><span id="line-611">                case "tbody":</span>
<span class="source-line-no">612</span><span id="line-612">                case "thead":</span>
<span class="source-line-no">613</span><span id="line-613">                case "tfoot":</span>
<span class="source-line-no">614</span><span id="line-614">                    transition(HtmlTreeBuilderState.InTableBody);</span>
<span class="source-line-no">615</span><span id="line-615">                    break LOOP;</span>
<span class="source-line-no">616</span><span id="line-616">                case "caption":</span>
<span class="source-line-no">617</span><span id="line-617">                    transition(HtmlTreeBuilderState.InCaption);</span>
<span class="source-line-no">618</span><span id="line-618">                    break LOOP;</span>
<span class="source-line-no">619</span><span id="line-619">                case "colgroup":</span>
<span class="source-line-no">620</span><span id="line-620">                    transition(HtmlTreeBuilderState.InColumnGroup);</span>
<span class="source-line-no">621</span><span id="line-621">                    break LOOP;</span>
<span class="source-line-no">622</span><span id="line-622">                case "table":</span>
<span class="source-line-no">623</span><span id="line-623">                    transition(HtmlTreeBuilderState.InTable);</span>
<span class="source-line-no">624</span><span id="line-624">                    break LOOP;</span>
<span class="source-line-no">625</span><span id="line-625">                case "template":</span>
<span class="source-line-no">626</span><span id="line-626">                    HtmlTreeBuilderState tmplState = currentTemplateMode();</span>
<span class="source-line-no">627</span><span id="line-627">                    Validate.notNull(tmplState, "Bug: no template insertion mode on stack!");</span>
<span class="source-line-no">628</span><span id="line-628">                    transition(tmplState);</span>
<span class="source-line-no">629</span><span id="line-629">                    break LOOP;</span>
<span class="source-line-no">630</span><span id="line-630">                case "head":</span>
<span class="source-line-no">631</span><span id="line-631">                    if (!last) {</span>
<span class="source-line-no">632</span><span id="line-632">                        transition(HtmlTreeBuilderState.InHead);</span>
<span class="source-line-no">633</span><span id="line-633">                        break LOOP;</span>
<span class="source-line-no">634</span><span id="line-634">                    }</span>
<span class="source-line-no">635</span><span id="line-635">                    break;</span>
<span class="source-line-no">636</span><span id="line-636">                case "body":</span>
<span class="source-line-no">637</span><span id="line-637">                    transition(HtmlTreeBuilderState.InBody);</span>
<span class="source-line-no">638</span><span id="line-638">                    break LOOP;</span>
<span class="source-line-no">639</span><span id="line-639">                case "frameset":</span>
<span class="source-line-no">640</span><span id="line-640">                    transition(HtmlTreeBuilderState.InFrameset);</span>
<span class="source-line-no">641</span><span id="line-641">                    break LOOP;</span>
<span class="source-line-no">642</span><span id="line-642">                case "html":</span>
<span class="source-line-no">643</span><span id="line-643">                    transition(headElement == null ? HtmlTreeBuilderState.BeforeHead : HtmlTreeBuilderState.AfterHead);</span>
<span class="source-line-no">644</span><span id="line-644">                    break LOOP;</span>
<span class="source-line-no">645</span><span id="line-645">            }</span>
<span class="source-line-no">646</span><span id="line-646">            if (last) {</span>
<span class="source-line-no">647</span><span id="line-647">                transition(HtmlTreeBuilderState.InBody);</span>
<span class="source-line-no">648</span><span id="line-648">                break;</span>
<span class="source-line-no">649</span><span id="line-649">            }</span>
<span class="source-line-no">650</span><span id="line-650">        }</span>
<span class="source-line-no">651</span><span id="line-651">        return state != origState;</span>
<span class="source-line-no">652</span><span id="line-652">    }</span>
<span class="source-line-no">653</span><span id="line-653"></span>
<span class="source-line-no">654</span><span id="line-654">    /** Places the body back onto the stack and moves to InBody, for cases in AfterBody / AfterAfterBody when more content comes */</span>
<span class="source-line-no">655</span><span id="line-655">    void resetBody() {</span>
<span class="source-line-no">656</span><span id="line-656">        if (!onStack("body")) {</span>
<span class="source-line-no">657</span><span id="line-657">            stack.add(doc.body()); // not onNodeInserted, as already seen</span>
<span class="source-line-no">658</span><span id="line-658">        }</span>
<span class="source-line-no">659</span><span id="line-659">        transition(HtmlTreeBuilderState.InBody);</span>
<span class="source-line-no">660</span><span id="line-660">    }</span>
<span class="source-line-no">661</span><span id="line-661"></span>
<span class="source-line-no">662</span><span id="line-662">    // todo: tidy up in specific scope methods</span>
<span class="source-line-no">663</span><span id="line-663">    private final String[] specificScopeTarget = {null};</span>
<span class="source-line-no">664</span><span id="line-664"></span>
<span class="source-line-no">665</span><span id="line-665">    private boolean inSpecificScope(String targetName, String[] baseTypes, String[] extraTypes) {</span>
<span class="source-line-no">666</span><span id="line-666">        specificScopeTarget[0] = targetName;</span>
<span class="source-line-no">667</span><span id="line-667">        return inSpecificScope(specificScopeTarget, baseTypes, extraTypes);</span>
<span class="source-line-no">668</span><span id="line-668">    }</span>
<span class="source-line-no">669</span><span id="line-669"></span>
<span class="source-line-no">670</span><span id="line-670">    private boolean inSpecificScope(String[] targetNames, String[] baseTypes, @Nullable String[] extraTypes) {</span>
<span class="source-line-no">671</span><span id="line-671">        // https://html.spec.whatwg.org/multipage/parsing.html#has-an-element-in-the-specific-scope</span>
<span class="source-line-no">672</span><span id="line-672">        final int bottom = stack.size() -1;</span>
<span class="source-line-no">673</span><span id="line-673">        final int top = bottom &gt; MaxScopeSearchDepth ? bottom - MaxScopeSearchDepth : 0;</span>
<span class="source-line-no">674</span><span id="line-674">        // don't walk too far up the tree</span>
<span class="source-line-no">675</span><span id="line-675"></span>
<span class="source-line-no">676</span><span id="line-676">        for (int pos = bottom; pos &gt;= top; pos--) {</span>
<span class="source-line-no">677</span><span id="line-677">            Element el = stack.get(pos);</span>
<span class="source-line-no">678</span><span id="line-678">            if (!el.tag().namespace().equals(NamespaceHtml)) continue;</span>
<span class="source-line-no">679</span><span id="line-679"></span>
<span class="source-line-no">680</span><span id="line-680">            final String elName = el.normalName();</span>
<span class="source-line-no">681</span><span id="line-681">            if (inSorted(elName, targetNames))</span>
<span class="source-line-no">682</span><span id="line-682">                return true;</span>
<span class="source-line-no">683</span><span id="line-683">            if (inSorted(elName, baseTypes))</span>
<span class="source-line-no">684</span><span id="line-684">                return false;</span>
<span class="source-line-no">685</span><span id="line-685">            if (extraTypes != null &amp;&amp; inSorted(elName, extraTypes))</span>
<span class="source-line-no">686</span><span id="line-686">                return false;</span>
<span class="source-line-no">687</span><span id="line-687">        }</span>
<span class="source-line-no">688</span><span id="line-688">        //Validate.fail("Should not be reachable"); // would end up false because hitting 'html' at root (basetypes)</span>
<span class="source-line-no">689</span><span id="line-689">        return false;</span>
<span class="source-line-no">690</span><span id="line-690">    }</span>
<span class="source-line-no">691</span><span id="line-691"></span>
<span class="source-line-no">692</span><span id="line-692">    boolean inScope(String[] targetNames) {</span>
<span class="source-line-no">693</span><span id="line-693">        return inSpecificScope(targetNames, TagsSearchInScope, null);</span>
<span class="source-line-no">694</span><span id="line-694">    }</span>
<span class="source-line-no">695</span><span id="line-695"></span>
<span class="source-line-no">696</span><span id="line-696">    boolean inScope(String targetName) {</span>
<span class="source-line-no">697</span><span id="line-697">        return inScope(targetName, null);</span>
<span class="source-line-no">698</span><span id="line-698">    }</span>
<span class="source-line-no">699</span><span id="line-699"></span>
<span class="source-line-no">700</span><span id="line-700">    boolean inScope(String targetName, String[] extras) {</span>
<span class="source-line-no">701</span><span id="line-701">        return inSpecificScope(targetName, TagsSearchInScope, extras);</span>
<span class="source-line-no">702</span><span id="line-702">        // todo: in mathml namespace: mi, mo, mn, ms, mtext annotation-xml</span>
<span class="source-line-no">703</span><span id="line-703">        // todo: in svg namespace: forignOjbect, desc, title</span>
<span class="source-line-no">704</span><span id="line-704">    }</span>
<span class="source-line-no">705</span><span id="line-705"></span>
<span class="source-line-no">706</span><span id="line-706">    boolean inListItemScope(String targetName) {</span>
<span class="source-line-no">707</span><span id="line-707">        return inScope(targetName, TagSearchList);</span>
<span class="source-line-no">708</span><span id="line-708">    }</span>
<span class="source-line-no">709</span><span id="line-709"></span>
<span class="source-line-no">710</span><span id="line-710">    boolean inButtonScope(String targetName) {</span>
<span class="source-line-no">711</span><span id="line-711">        return inScope(targetName, TagSearchButton);</span>
<span class="source-line-no">712</span><span id="line-712">    }</span>
<span class="source-line-no">713</span><span id="line-713"></span>
<span class="source-line-no">714</span><span id="line-714">    boolean inTableScope(String targetName) {</span>
<span class="source-line-no">715</span><span id="line-715">        return inSpecificScope(targetName, TagSearchTableScope, null);</span>
<span class="source-line-no">716</span><span id="line-716">    }</span>
<span class="source-line-no">717</span><span id="line-717"></span>
<span class="source-line-no">718</span><span id="line-718">    boolean inSelectScope(String targetName) {</span>
<span class="source-line-no">719</span><span id="line-719">        for (int pos = stack.size() -1; pos &gt;= 0; pos--) {</span>
<span class="source-line-no">720</span><span id="line-720">            Element el = stack.get(pos);</span>
<span class="source-line-no">721</span><span id="line-721">            String elName = el.normalName();</span>
<span class="source-line-no">722</span><span id="line-722">            if (elName.equals(targetName))</span>
<span class="source-line-no">723</span><span id="line-723">                return true;</span>
<span class="source-line-no">724</span><span id="line-724">            if (!inSorted(elName, TagSearchSelectScope)) // all elements except</span>
<span class="source-line-no">725</span><span id="line-725">                return false;</span>
<span class="source-line-no">726</span><span id="line-726">        }</span>
<span class="source-line-no">727</span><span id="line-727">        Validate.fail("Should not be reachable");</span>
<span class="source-line-no">728</span><span id="line-728">        return false;</span>
<span class="source-line-no">729</span><span id="line-729">    }</span>
<span class="source-line-no">730</span><span id="line-730"></span>
<span class="source-line-no">731</span><span id="line-731">    /** Tests if there is some element on the stack that is not in the provided set. */</span>
<span class="source-line-no">732</span><span id="line-732">    boolean onStackNot(String[] allowedTags) {</span>
<span class="source-line-no">733</span><span id="line-733">        final int bottom = stack.size() -1;</span>
<span class="source-line-no">734</span><span id="line-734">        final int top = bottom &gt; MaxScopeSearchDepth ? bottom - MaxScopeSearchDepth : 0;</span>
<span class="source-line-no">735</span><span id="line-735">        // don't walk too far up the tree</span>
<span class="source-line-no">736</span><span id="line-736"></span>
<span class="source-line-no">737</span><span id="line-737">        for (int pos = bottom; pos &gt;= top; pos--) {</span>
<span class="source-line-no">738</span><span id="line-738">            final String elName = stack.get(pos).normalName();</span>
<span class="source-line-no">739</span><span id="line-739">            if (!inSorted(elName, allowedTags))</span>
<span class="source-line-no">740</span><span id="line-740">                return true;</span>
<span class="source-line-no">741</span><span id="line-741">        }</span>
<span class="source-line-no">742</span><span id="line-742">        return false;</span>
<span class="source-line-no">743</span><span id="line-743">    }</span>
<span class="source-line-no">744</span><span id="line-744"></span>
<span class="source-line-no">745</span><span id="line-745">    void setHeadElement(Element headElement) {</span>
<span class="source-line-no">746</span><span id="line-746">        this.headElement = headElement;</span>
<span class="source-line-no">747</span><span id="line-747">    }</span>
<span class="source-line-no">748</span><span id="line-748"></span>
<span class="source-line-no">749</span><span id="line-749">    Element getHeadElement() {</span>
<span class="source-line-no">750</span><span id="line-750">        return headElement;</span>
<span class="source-line-no">751</span><span id="line-751">    }</span>
<span class="source-line-no">752</span><span id="line-752"></span>
<span class="source-line-no">753</span><span id="line-753">    boolean isFosterInserts() {</span>
<span class="source-line-no">754</span><span id="line-754">        return fosterInserts;</span>
<span class="source-line-no">755</span><span id="line-755">    }</span>
<span class="source-line-no">756</span><span id="line-756"></span>
<span class="source-line-no">757</span><span id="line-757">    void setFosterInserts(boolean fosterInserts) {</span>
<span class="source-line-no">758</span><span id="line-758">        this.fosterInserts = fosterInserts;</span>
<span class="source-line-no">759</span><span id="line-759">    }</span>
<span class="source-line-no">760</span><span id="line-760"></span>
<span class="source-line-no">761</span><span id="line-761">    @Nullable FormElement getFormElement() {</span>
<span class="source-line-no">762</span><span id="line-762">        return formElement;</span>
<span class="source-line-no">763</span><span id="line-763">    }</span>
<span class="source-line-no">764</span><span id="line-764"></span>
<span class="source-line-no">765</span><span id="line-765">    void setFormElement(FormElement formElement) {</span>
<span class="source-line-no">766</span><span id="line-766">        this.formElement = formElement;</span>
<span class="source-line-no">767</span><span id="line-767">    }</span>
<span class="source-line-no">768</span><span id="line-768"></span>
<span class="source-line-no">769</span><span id="line-769">    void resetPendingTableCharacters() {</span>
<span class="source-line-no">770</span><span id="line-770">        pendingTableCharacters.clear();</span>
<span class="source-line-no">771</span><span id="line-771">    }</span>
<span class="source-line-no">772</span><span id="line-772"></span>
<span class="source-line-no">773</span><span id="line-773">    List&lt;Token.Character&gt; getPendingTableCharacters() {</span>
<span class="source-line-no">774</span><span id="line-774">        return pendingTableCharacters;</span>
<span class="source-line-no">775</span><span id="line-775">    }</span>
<span class="source-line-no">776</span><span id="line-776"></span>
<span class="source-line-no">777</span><span id="line-777">    void addPendingTableCharacters(Token.Character c) {</span>
<span class="source-line-no">778</span><span id="line-778">        // make a clone of the token to maintain its state (as Tokens are otherwise reset)</span>
<span class="source-line-no">779</span><span id="line-779">        Token.Character clone = c.clone();</span>
<span class="source-line-no">780</span><span id="line-780">        pendingTableCharacters.add(clone);</span>
<span class="source-line-no">781</span><span id="line-781">    }</span>
<span class="source-line-no">782</span><span id="line-782"></span>
<span class="source-line-no">783</span><span id="line-783">    /**</span>
<span class="source-line-no">784</span><span id="line-784">     13.2.6.3 Closing elements that have implied end tags</span>
<span class="source-line-no">785</span><span id="line-785">     When the steps below require the UA to generate implied end tags, then, while the current node is a dd element, a dt element, an li element, an optgroup element, an option element, a p element, an rb element, an rp element, an rt element, or an rtc element, the UA must pop the current node off the stack of open elements.</span>
<span class="source-line-no">786</span><span id="line-786"></span>
<span class="source-line-no">787</span><span id="line-787">     If a step requires the UA to generate implied end tags but lists an element to exclude from the process, then the UA must perform the above steps as if that element was not in the above list.</span>
<span class="source-line-no">788</span><span id="line-788"></span>
<span class="source-line-no">789</span><span id="line-789">     When the steps below require the UA to generate all implied end tags thoroughly, then, while the current node is a caption element, a colgroup element, a dd element, a dt element, an li element, an optgroup element, an option element, a p element, an rb element, an rp element, an rt element, an rtc element, a tbody element, a td element, a tfoot element, a th element, a thead element, or a tr element, the UA must pop the current node off the stack of open elements.</span>
<span class="source-line-no">790</span><span id="line-790"></span>
<span class="source-line-no">791</span><span id="line-791">     @param excludeTag If a step requires the UA to generate implied end tags but lists an element to exclude from the</span>
<span class="source-line-no">792</span><span id="line-792">     process, then the UA must perform the above steps as if that element was not in the above list.</span>
<span class="source-line-no">793</span><span id="line-793">     */</span>
<span class="source-line-no">794</span><span id="line-794">    void generateImpliedEndTags(String excludeTag) {</span>
<span class="source-line-no">795</span><span id="line-795">        while (inSorted(currentElement().normalName(), TagSearchEndTags)) {</span>
<span class="source-line-no">796</span><span id="line-796">            if (excludeTag != null &amp;&amp; currentElementIs(excludeTag))</span>
<span class="source-line-no">797</span><span id="line-797">                break;</span>
<span class="source-line-no">798</span><span id="line-798">            pop();</span>
<span class="source-line-no">799</span><span id="line-799">        }</span>
<span class="source-line-no">800</span><span id="line-800">    }</span>
<span class="source-line-no">801</span><span id="line-801"></span>
<span class="source-line-no">802</span><span id="line-802">    void generateImpliedEndTags() {</span>
<span class="source-line-no">803</span><span id="line-803">        generateImpliedEndTags(false);</span>
<span class="source-line-no">804</span><span id="line-804">    }</span>
<span class="source-line-no">805</span><span id="line-805"></span>
<span class="source-line-no">806</span><span id="line-806">    /**</span>
<span class="source-line-no">807</span><span id="line-807">     Pops HTML elements off the stack according to the implied end tag rules</span>
<span class="source-line-no">808</span><span id="line-808">     @param thorough if we are thorough (includes table elements etc) or not</span>
<span class="source-line-no">809</span><span id="line-809">     */</span>
<span class="source-line-no">810</span><span id="line-810">    void generateImpliedEndTags(boolean thorough) {</span>
<span class="source-line-no">811</span><span id="line-811">        final String[] search = thorough ? TagThoroughSearchEndTags : TagSearchEndTags;</span>
<span class="source-line-no">812</span><span id="line-812">        while (NamespaceHtml.equals(currentElement().tag().namespace())</span>
<span class="source-line-no">813</span><span id="line-813">            &amp;&amp; inSorted(currentElement().normalName(), search)) {</span>
<span class="source-line-no">814</span><span id="line-814">            pop();</span>
<span class="source-line-no">815</span><span id="line-815">        }</span>
<span class="source-line-no">816</span><span id="line-816">    }</span>
<span class="source-line-no">817</span><span id="line-817"></span>
<span class="source-line-no">818</span><span id="line-818">    void closeElement(String name) {</span>
<span class="source-line-no">819</span><span id="line-819">        generateImpliedEndTags(name);</span>
<span class="source-line-no">820</span><span id="line-820">        if (!name.equals(currentElement().normalName())) error(state());</span>
<span class="source-line-no">821</span><span id="line-821">        popStackToClose(name);</span>
<span class="source-line-no">822</span><span id="line-822">    }</span>
<span class="source-line-no">823</span><span id="line-823"></span>
<span class="source-line-no">824</span><span id="line-824">    static boolean isSpecial(Element el) {</span>
<span class="source-line-no">825</span><span id="line-825">        // todo: mathml's mi, mo, mn</span>
<span class="source-line-no">826</span><span id="line-826">        // todo: svg's foreigObject, desc, title</span>
<span class="source-line-no">827</span><span id="line-827">        String name = el.normalName();</span>
<span class="source-line-no">828</span><span id="line-828">        return inSorted(name, TagSearchSpecial);</span>
<span class="source-line-no">829</span><span id="line-829">    }</span>
<span class="source-line-no">830</span><span id="line-830"></span>
<span class="source-line-no">831</span><span id="line-831">    Element lastFormattingElement() {</span>
<span class="source-line-no">832</span><span id="line-832">        return formattingElements.size() &gt; 0 ? formattingElements.get(formattingElements.size()-1) : null;</span>
<span class="source-line-no">833</span><span id="line-833">    }</span>
<span class="source-line-no">834</span><span id="line-834"></span>
<span class="source-line-no">835</span><span id="line-835">    int positionOfElement(Element el){</span>
<span class="source-line-no">836</span><span id="line-836">        for (int i = 0; i &lt; formattingElements.size(); i++){</span>
<span class="source-line-no">837</span><span id="line-837">            if (el == formattingElements.get(i))</span>
<span class="source-line-no">838</span><span id="line-838">                return i;</span>
<span class="source-line-no">839</span><span id="line-839">        }</span>
<span class="source-line-no">840</span><span id="line-840">        return -1;</span>
<span class="source-line-no">841</span><span id="line-841">    }</span>
<span class="source-line-no">842</span><span id="line-842"></span>
<span class="source-line-no">843</span><span id="line-843">    Element removeLastFormattingElement() {</span>
<span class="source-line-no">844</span><span id="line-844">        int size = formattingElements.size();</span>
<span class="source-line-no">845</span><span id="line-845">        if (size &gt; 0)</span>
<span class="source-line-no">846</span><span id="line-846">            return formattingElements.remove(size-1);</span>
<span class="source-line-no">847</span><span id="line-847">        else</span>
<span class="source-line-no">848</span><span id="line-848">            return null;</span>
<span class="source-line-no">849</span><span id="line-849">    }</span>
<span class="source-line-no">850</span><span id="line-850"></span>
<span class="source-line-no">851</span><span id="line-851">    // active formatting elements</span>
<span class="source-line-no">852</span><span id="line-852">    void pushActiveFormattingElements(Element in) {</span>
<span class="source-line-no">853</span><span id="line-853">        checkActiveFormattingElements(in);</span>
<span class="source-line-no">854</span><span id="line-854">        formattingElements.add(in);</span>
<span class="source-line-no">855</span><span id="line-855">    }</span>
<span class="source-line-no">856</span><span id="line-856"></span>
<span class="source-line-no">857</span><span id="line-857">    void pushWithBookmark(Element in, int bookmark){</span>
<span class="source-line-no">858</span><span id="line-858">        checkActiveFormattingElements(in);</span>
<span class="source-line-no">859</span><span id="line-859">        // catch any range errors and assume bookmark is incorrect - saves a redundant range check.</span>
<span class="source-line-no">860</span><span id="line-860">        try {</span>
<span class="source-line-no">861</span><span id="line-861">            formattingElements.add(bookmark, in);</span>
<span class="source-line-no">862</span><span id="line-862">        } catch (IndexOutOfBoundsException e) {</span>
<span class="source-line-no">863</span><span id="line-863">            formattingElements.add(in);</span>
<span class="source-line-no">864</span><span id="line-864">        }</span>
<span class="source-line-no">865</span><span id="line-865">    }</span>
<span class="source-line-no">866</span><span id="line-866"></span>
<span class="source-line-no">867</span><span id="line-867">    void checkActiveFormattingElements(Element in){</span>
<span class="source-line-no">868</span><span id="line-868">        int numSeen = 0;</span>
<span class="source-line-no">869</span><span id="line-869">        final int size = formattingElements.size() -1;</span>
<span class="source-line-no">870</span><span id="line-870">        int ceil = size - maxUsedFormattingElements; if (ceil &lt;0) ceil = 0;</span>
<span class="source-line-no">871</span><span id="line-871"></span>
<span class="source-line-no">872</span><span id="line-872">        for (int pos = size; pos &gt;= ceil; pos--) {</span>
<span class="source-line-no">873</span><span id="line-873">            Element el = formattingElements.get(pos);</span>
<span class="source-line-no">874</span><span id="line-874">            if (el == null) // marker</span>
<span class="source-line-no">875</span><span id="line-875">                break;</span>
<span class="source-line-no">876</span><span id="line-876"></span>
<span class="source-line-no">877</span><span id="line-877">            if (isSameFormattingElement(in, el))</span>
<span class="source-line-no">878</span><span id="line-878">                numSeen++;</span>
<span class="source-line-no">879</span><span id="line-879"></span>
<span class="source-line-no">880</span><span id="line-880">            if (numSeen == 3) {</span>
<span class="source-line-no">881</span><span id="line-881">                formattingElements.remove(pos);</span>
<span class="source-line-no">882</span><span id="line-882">                break;</span>
<span class="source-line-no">883</span><span id="line-883">            }</span>
<span class="source-line-no">884</span><span id="line-884">        }</span>
<span class="source-line-no">885</span><span id="line-885">    }</span>
<span class="source-line-no">886</span><span id="line-886"></span>
<span class="source-line-no">887</span><span id="line-887">    private static boolean isSameFormattingElement(Element a, Element b) {</span>
<span class="source-line-no">888</span><span id="line-888">        // same if: same namespace, tag, and attributes. Element.equals only checks tag, might in future check children</span>
<span class="source-line-no">889</span><span id="line-889">        return a.normalName().equals(b.normalName()) &amp;&amp;</span>
<span class="source-line-no">890</span><span id="line-890">                // a.namespace().equals(b.namespace()) &amp;&amp;</span>
<span class="source-line-no">891</span><span id="line-891">                a.attributes().equals(b.attributes());</span>
<span class="source-line-no">892</span><span id="line-892">        // todo: namespaces</span>
<span class="source-line-no">893</span><span id="line-893">    }</span>
<span class="source-line-no">894</span><span id="line-894"></span>
<span class="source-line-no">895</span><span id="line-895">    void reconstructFormattingElements() {</span>
<span class="source-line-no">896</span><span id="line-896">        if (stack.size() &gt; maxQueueDepth)</span>
<span class="source-line-no">897</span><span id="line-897">            return;</span>
<span class="source-line-no">898</span><span id="line-898">        Element last = lastFormattingElement();</span>
<span class="source-line-no">899</span><span id="line-899">        if (last == null || onStack(last))</span>
<span class="source-line-no">900</span><span id="line-900">            return;</span>
<span class="source-line-no">901</span><span id="line-901"></span>
<span class="source-line-no">902</span><span id="line-902">        Element entry = last;</span>
<span class="source-line-no">903</span><span id="line-903">        int size = formattingElements.size();</span>
<span class="source-line-no">904</span><span id="line-904">        int ceil = size - maxUsedFormattingElements; if (ceil &lt;0) ceil = 0;</span>
<span class="source-line-no">905</span><span id="line-905">        int pos = size - 1;</span>
<span class="source-line-no">906</span><span id="line-906">        boolean skip = false;</span>
<span class="source-line-no">907</span><span id="line-907">        while (true) {</span>
<span class="source-line-no">908</span><span id="line-908">            if (pos == ceil) { // step 4. if none before, skip to 8</span>
<span class="source-line-no">909</span><span id="line-909">                skip = true;</span>
<span class="source-line-no">910</span><span id="line-910">                break;</span>
<span class="source-line-no">911</span><span id="line-911">            }</span>
<span class="source-line-no">912</span><span id="line-912">            entry = formattingElements.get(--pos); // step 5. one earlier than entry</span>
<span class="source-line-no">913</span><span id="line-913">            if (entry == null || onStack(entry)) // step 6 - neither marker nor on stack</span>
<span class="source-line-no">914</span><span id="line-914">                break; // jump to 8, else continue back to 4</span>
<span class="source-line-no">915</span><span id="line-915">        }</span>
<span class="source-line-no">916</span><span id="line-916">        while(true) {</span>
<span class="source-line-no">917</span><span id="line-917">            if (!skip) // step 7: on later than entry</span>
<span class="source-line-no">918</span><span id="line-918">                entry = formattingElements.get(++pos);</span>
<span class="source-line-no">919</span><span id="line-919">            Validate.notNull(entry); // should not occur, as we break at last element</span>
<span class="source-line-no">920</span><span id="line-920"></span>
<span class="source-line-no">921</span><span id="line-921">            // 8. create new element from element, 9 insert into current node, onto stack</span>
<span class="source-line-no">922</span><span id="line-922">            skip = false; // can only skip increment from 4.</span>
<span class="source-line-no">923</span><span id="line-923">            Element newEl = new Element(tagFor(entry.normalName(), settings), null, entry.attributes().clone());</span>
<span class="source-line-no">924</span><span id="line-924">            doInsertElement(newEl, null);</span>
<span class="source-line-no">925</span><span id="line-925"></span>
<span class="source-line-no">926</span><span id="line-926">            // 10. replace entry with new entry</span>
<span class="source-line-no">927</span><span id="line-927">            formattingElements.set(pos, newEl);</span>
<span class="source-line-no">928</span><span id="line-928"></span>
<span class="source-line-no">929</span><span id="line-929">            // 11</span>
<span class="source-line-no">930</span><span id="line-930">            if (pos == size-1) // if not last entry in list, jump to 7</span>
<span class="source-line-no">931</span><span id="line-931">                break;</span>
<span class="source-line-no">932</span><span id="line-932">        }</span>
<span class="source-line-no">933</span><span id="line-933">    }</span>
<span class="source-line-no">934</span><span id="line-934">    private static final int maxUsedFormattingElements = 12; // limit how many elements get recreated</span>
<span class="source-line-no">935</span><span id="line-935"></span>
<span class="source-line-no">936</span><span id="line-936">    void clearFormattingElementsToLastMarker() {</span>
<span class="source-line-no">937</span><span id="line-937">        while (!formattingElements.isEmpty()) {</span>
<span class="source-line-no">938</span><span id="line-938">            Element el = removeLastFormattingElement();</span>
<span class="source-line-no">939</span><span id="line-939">            if (el == null)</span>
<span class="source-line-no">940</span><span id="line-940">                break;</span>
<span class="source-line-no">941</span><span id="line-941">        }</span>
<span class="source-line-no">942</span><span id="line-942">    }</span>
<span class="source-line-no">943</span><span id="line-943"></span>
<span class="source-line-no">944</span><span id="line-944">    void removeFromActiveFormattingElements(Element el) {</span>
<span class="source-line-no">945</span><span id="line-945">        for (int pos = formattingElements.size() -1; pos &gt;= 0; pos--) {</span>
<span class="source-line-no">946</span><span id="line-946">            Element next = formattingElements.get(pos);</span>
<span class="source-line-no">947</span><span id="line-947">            if (next == el) {</span>
<span class="source-line-no">948</span><span id="line-948">                formattingElements.remove(pos);</span>
<span class="source-line-no">949</span><span id="line-949">                break;</span>
<span class="source-line-no">950</span><span id="line-950">            }</span>
<span class="source-line-no">951</span><span id="line-951">        }</span>
<span class="source-line-no">952</span><span id="line-952">    }</span>
<span class="source-line-no">953</span><span id="line-953"></span>
<span class="source-line-no">954</span><span id="line-954">    boolean isInActiveFormattingElements(Element el) {</span>
<span class="source-line-no">955</span><span id="line-955">        return onStack(formattingElements, el);</span>
<span class="source-line-no">956</span><span id="line-956">    }</span>
<span class="source-line-no">957</span><span id="line-957"></span>
<span class="source-line-no">958</span><span id="line-958">    @Nullable</span>
<span class="source-line-no">959</span><span id="line-959">    Element getActiveFormattingElement(String nodeName) {</span>
<span class="source-line-no">960</span><span id="line-960">        for (int pos = formattingElements.size() -1; pos &gt;= 0; pos--) {</span>
<span class="source-line-no">961</span><span id="line-961">            Element next = formattingElements.get(pos);</span>
<span class="source-line-no">962</span><span id="line-962">            if (next == null) // scope marker</span>
<span class="source-line-no">963</span><span id="line-963">                break;</span>
<span class="source-line-no">964</span><span id="line-964">            else if (next.nameIs(nodeName))</span>
<span class="source-line-no">965</span><span id="line-965">                return next;</span>
<span class="source-line-no">966</span><span id="line-966">        }</span>
<span class="source-line-no">967</span><span id="line-967">        return null;</span>
<span class="source-line-no">968</span><span id="line-968">    }</span>
<span class="source-line-no">969</span><span id="line-969"></span>
<span class="source-line-no">970</span><span id="line-970">    void replaceActiveFormattingElement(Element out, Element in) {</span>
<span class="source-line-no">971</span><span id="line-971">        replaceInQueue(formattingElements, out, in);</span>
<span class="source-line-no">972</span><span id="line-972">    }</span>
<span class="source-line-no">973</span><span id="line-973"></span>
<span class="source-line-no">974</span><span id="line-974">    void insertMarkerToFormattingElements() {</span>
<span class="source-line-no">975</span><span id="line-975">        formattingElements.add(null);</span>
<span class="source-line-no">976</span><span id="line-976">    }</span>
<span class="source-line-no">977</span><span id="line-977"></span>
<span class="source-line-no">978</span><span id="line-978">    void insertInFosterParent(Node in) {</span>
<span class="source-line-no">979</span><span id="line-979">        Element fosterParent;</span>
<span class="source-line-no">980</span><span id="line-980">        Element lastTable = getFromStack("table");</span>
<span class="source-line-no">981</span><span id="line-981">        boolean isLastTableParent = false;</span>
<span class="source-line-no">982</span><span id="line-982">        if (lastTable != null) {</span>
<span class="source-line-no">983</span><span id="line-983">            if (lastTable.parent() != null) {</span>
<span class="source-line-no">984</span><span id="line-984">                fosterParent = lastTable.parent();</span>
<span class="source-line-no">985</span><span id="line-985">                isLastTableParent = true;</span>
<span class="source-line-no">986</span><span id="line-986">            } else</span>
<span class="source-line-no">987</span><span id="line-987">                fosterParent = aboveOnStack(lastTable);</span>
<span class="source-line-no">988</span><span id="line-988">        } else { // no table == frag</span>
<span class="source-line-no">989</span><span id="line-989">            fosterParent = stack.get(0);</span>
<span class="source-line-no">990</span><span id="line-990">        }</span>
<span class="source-line-no">991</span><span id="line-991"></span>
<span class="source-line-no">992</span><span id="line-992">        if (isLastTableParent) {</span>
<span class="source-line-no">993</span><span id="line-993">            Validate.notNull(lastTable); // last table cannot be null by this point.</span>
<span class="source-line-no">994</span><span id="line-994">            lastTable.before(in);</span>
<span class="source-line-no">995</span><span id="line-995">        }</span>
<span class="source-line-no">996</span><span id="line-996">        else</span>
<span class="source-line-no">997</span><span id="line-997">            fosterParent.appendChild(in);</span>
<span class="source-line-no">998</span><span id="line-998">    }</span>
<span class="source-line-no">999</span><span id="line-999"></span>
<span class="source-line-no">1000</span><span id="line-1000">    // Template Insertion Mode stack</span>
<span class="source-line-no">1001</span><span id="line-1001">    void pushTemplateMode(HtmlTreeBuilderState state) {</span>
<span class="source-line-no">1002</span><span id="line-1002">        tmplInsertMode.add(state);</span>
<span class="source-line-no">1003</span><span id="line-1003">    }</span>
<span class="source-line-no">1004</span><span id="line-1004"></span>
<span class="source-line-no">1005</span><span id="line-1005">    @Nullable HtmlTreeBuilderState popTemplateMode() {</span>
<span class="source-line-no">1006</span><span id="line-1006">        if (tmplInsertMode.size() &gt; 0) {</span>
<span class="source-line-no">1007</span><span id="line-1007">            return tmplInsertMode.remove(tmplInsertMode.size() -1);</span>
<span class="source-line-no">1008</span><span id="line-1008">        } else {</span>
<span class="source-line-no">1009</span><span id="line-1009">            return null;</span>
<span class="source-line-no">1010</span><span id="line-1010">        }</span>
<span class="source-line-no">1011</span><span id="line-1011">    }</span>
<span class="source-line-no">1012</span><span id="line-1012"></span>
<span class="source-line-no">1013</span><span id="line-1013">    int templateModeSize() {</span>
<span class="source-line-no">1014</span><span id="line-1014">        return tmplInsertMode.size();</span>
<span class="source-line-no">1015</span><span id="line-1015">    }</span>
<span class="source-line-no">1016</span><span id="line-1016"></span>
<span class="source-line-no">1017</span><span id="line-1017">    @Nullable HtmlTreeBuilderState currentTemplateMode() {</span>
<span class="source-line-no">1018</span><span id="line-1018">        return (tmplInsertMode.size() &gt; 0) ? tmplInsertMode.get(tmplInsertMode.size() -1)  : null;</span>
<span class="source-line-no">1019</span><span id="line-1019">    }</span>
<span class="source-line-no">1020</span><span id="line-1020"></span>
<span class="source-line-no">1021</span><span id="line-1021">    @Override</span>
<span class="source-line-no">1022</span><span id="line-1022">    public String toString() {</span>
<span class="source-line-no">1023</span><span id="line-1023">        return "TreeBuilder{" +</span>
<span class="source-line-no">1024</span><span id="line-1024">                "currentToken=" + currentToken +</span>
<span class="source-line-no">1025</span><span id="line-1025">                ", state=" + state +</span>
<span class="source-line-no">1026</span><span id="line-1026">                ", currentElement=" + currentElement() +</span>
<span class="source-line-no">1027</span><span id="line-1027">                '}';</span>
<span class="source-line-no">1028</span><span id="line-1028">    }</span>
<span class="source-line-no">1029</span><span id="line-1029"></span>
<span class="source-line-no">1030</span><span id="line-1030">    @Override protected boolean isContentForTagData(final String normalName) {</span>
<span class="source-line-no">1031</span><span id="line-1031">        return (normalName.equals("script") || normalName.equals("style"));</span>
<span class="source-line-no">1032</span><span id="line-1032">    }</span>
<span class="source-line-no">1033</span><span id="line-1033">}</span>




























































</pre>
</div>
</main>
</body>
</html>
